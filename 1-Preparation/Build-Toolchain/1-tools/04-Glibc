# Tools: Glibc 
# Build and install as lfs

# Create a symbolic link for LSB compliance. Additionally, 
# for x86_64, create a compatibility symbolic link required 
# for proper operation of the dynamic library loader: 
ln -sfv ../lib/ld-linux-x86-64.so.2 /tools/lib
ln -sfv ../lib/ld-linux-x86-64.so.2 /tools/lib/ld-lsb-x86-64.so.3

# Some of the Glibc programs use the non-FHS-compliant 
# /var/db directory to store their runtime data. Apply the 
# following patch to make such programs store their runtime 
# data in the FHS-compliant locations: 
patch -Np1 -i ../patches/glibc-2.42-fhs-1.patch 

# The Glibc documentation recommends building Glibc in a 
# dedicated build directory:
mkdir -v build32
cd       build32

# Set the build options for a 32-bit build
export  CARGS="--prefix=/tools  "
export CARGS+="--host=$LFS_TGT32 "
export CARGS+="--build=$(../scripts/config.guess) "
export CARGS+="--enable-kernel=5.4 "
export CARGS+="--disable-nscd "
export CARGS+="--libdir=/tools/lib32 "
export CARGS+="--libexecdir=/tools/lib32 "
export CARGS+="--with-headers=/tools/include "
export CARGS+="libc_cv_slibdir=/tools/lib32 "
export CARGS+="libc_cv_forced_unwind=yes "
export CARGS+="libc_cv_c_cleanup=yes "

# Configue source for 32-bit
CC="$LFS_TGT-gcc -m32" \
CXX="$LFS_TGT-g++ -m32" \
../configure $CARGS

# Compile
make

# Install
make DESTDIR=$PWD/DESTDIR install
cp -a DESTDIR/tools/lib32/* /tools/lib32/
mkdir -pv /tools/include/gnu
install -vm644 DESTDIR/tools/include/gnu/{lib-names,stubs}-32.h \
        /tools/include/gnu/
ln -svf ../lib32/ld-linux.so.2 /tools/lib/ld-linux.so.2

# Create a dedicated 64-bit build directory
mkdir -v ../build
cd ../build

# Now set the build options for a 64-bit build
export  CARGS="--prefix=/tools  "
export CARGS+="--host=$LFS_TGT "
export CARGS+="--build=$(../scripts/config.guess) "
export CARGS+="--enable-kernel=5.4 "
export CARGS+="--disable-nscd "
export CARGS+="--libdir=/tools/lib "
export CARGS+="--with-headers=/tools/include "
export CARGS+="libc_cv_slibdir=/tools/lib "
export CARGS+="libc_cv_forced_unwind=yes "
export CARGS+="libc_cv_c_cleanup=yes "

# Configure a 64-bit build:
../configure $CARGS

# Compile 64-bit build
make

# Install
make install 

# Fix a hard coded path to the executable loader in the ldd script
sed -i 's/tools\/lib64/tools\/lib32/' /tools/bin/ldd

# Some programs are hardcoded for lib64. Create a compatibility
# link
ln -sv lib /tools/lib64

# It is important to ensure that compiling and linking will work 
# as expected. We do this by performing some sanity checks: 
echo 'int main(){}' | $LFS_TGT-gcc -x c - -v -Wl,--verbose &> dummy64.log
mv a.out a64.out
echo 'int main(){}' | $LFS_TGT-gcc -m32 -x c - -v -Wl,--verbose &> dummy.log
readelf -l a64.out | grep ': /tools/lib64'
readelf -l a.out | grep ': /tools/lib'

# There should be no errors, and the output of the last command will 
# be (allowing for platform-specific differences in the dynamic 
# linker name): 
# [Requesting program interpreter: /tools/lib64/ld-linux-x86-64.so.2]
# [Requesting program interpreter: /tools/lib/ld-linux.so.2]

# Now make sure that we're set up to use the correct start files: 
grep -E -o "\/tools\/lib.*/S?crt[1in].*succeeded" dummy64.log
grep -E -o "\/tools\/lib.*/S?crt[1in].*succeeded" dummy.log

# The output of the commands should be: 
# /tools/lib/../lib/Scrt1.o succeeded
# /tools/lib/../lib/crti.o succeeded
# /tools/lib/../lib/crtn.o succeeded
# /tools/lib/../lib32/Scrt1.o succeeded
# /tools/lib/../lib32/crti.o succeeded
# /tools/lib/../lib32/crtn.o succeeded

#  Verify that the compiler is searching for the correct header files: 
grep -A4 "search starts here" dummy64.log
grep -A4 "search starts here" dummy.log

# These commands should return the same following output: 
# #include "..." search starts here:
# #include <...> search starts here:
#  /mnt/glfs/tools/lib/gcc/x86_64-lfs-linux-gnu/15.2.0/include
#  /mnt/glfs/tools/include
#  /mnt/glfs/tools/lib/gcc/x86_64-lfs-linux-gnu/15.2.0/include-fixed
# End of search list.


# Next, verify that the new linker is being used with the correct 
# search paths:
grep 'SEARCH.*/tools/lib' dummy64.log |sed 's|; |\n|g'
grep 'SEARCH.*/tools/lib' dummy.log |sed 's|; |\n|g'

# These commands should return the same 3rd & 4th lines
# SEARCH_DIR("=/tools/x86_64-lfs-linux-gnu/lib64")
# SEARCH_DIR("/tools/lib")
# SEARCH_DIR("/tools/lib32")
# SEARCH_DIR("=/tools/x86_64-lfs-linux-gnu/lib");
# SEARCH_DIR("=/tools/i386-lfs-linux-gnu/lib32")
# SEARCH_DIR("/tools/lib")
# SEARCH_DIR("/tools/lib32")
# SEARCH_DIR("=/tools/i386-lfs-linux-gnu/lib");

# Next make sure that we're using the correct libc:
grep "/lib.*/libc.so.6 " dummy64.log
grep "/lib.*/libc.so.6 " dummy.log

# The output of these commands should be: 
# attempt to open /mnt/lfs/tools/lib/libc.so.6 succeeded
# attempt to open /mnt/lfs/tools/lib32/libc.so.6 succeeded

# Make sure GCC is using the correct dynamic linker: 
grep found dummy64.log
grep found dummy.log

# The output of the these commands should be (allowing for 
# platform-specific differences in dynamic linker name): 
# found ld-linux-x86-64.so.2 at /mnt/lfs/tools/lib/ld-linux-x86-64.so.2
# found ld-linux.so.2 at /mnt/lfs/tools/lib32/ld-linux.so.2

# Once everything is working correctly, clean up the test files: 
rm -v a{,64}.out dummy{,64}.log

