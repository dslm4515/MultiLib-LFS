# Chroot: Toolchain - Expect (optional)
# This section is done in Chroot environment

# NOTE: This package is optional - Used for running
# testsuites.

# Expect needs PTYs to work. Verify that the PTYs are working 
# properly inside the chroot environment by performing a simple test:
python3 -c 'from pty import spawn; spawn(["echo", "ok"])'

# This command should output ok. If, instead, the output includes 
# "OSError: out of pty devices", then the environment is not set up 
# for proper PTY operation. You need to exit from the chroot environment,
# read "03-Prepare_VKS" again, and ensure the devpts file system 
# (and other virtual kernel file systems) mounted correctly. Then 
# reenter the chroot environment following "04-Enter_Chroot." This 
# issue needs to be resolved before continuing, or the test suites 
# requiring Expect (for example the test suites of Bash, Binutils, 
# GCC, GDBM, and of course Expect itself) will fail catastrophically, 
# and other subtle breakages may also happen.   

# Now, make some changes to allow the package with gcc-15.1 or later:
patch -Np1 -i ../patches/expect-5.45.4-gcc15-1.patch

# Set build options
export  CARGS="--prefix=/tools "
export CARGS+="--with-tcl=/tools/lib "
export CARGS+="--enable-shared "
export CARGS+="--disable-rpath "
export CARGS+="--mandir=/tools/share/man "
export CARGS+="--with-tclinclude=/tools/include "

# Configure source
./configure $CARGS

# Compile
make

# Install to toolchain
make install
ln -svf expect5.45.4/libexpect5.45.4.so /tools/lib
