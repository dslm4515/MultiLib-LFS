# Cross-Tools: GCC 
# Build and install as lfs

# GCC now requires the GMP, MPFR and MPC packages to build.
# Unpack them in-tree.
xz -cd ../pkgs/mpfr-4.2.2.tar.xz | tar -xf -
xz -cd ../pkgs/gmp-6.3.0.tar.xz | tar -xf -
gzip -cd ../pkgs/mpc-1.3.1.tar.gz | tar -xf -
mv -v mpfr-4.2.2 mpfr
mv -v gmp-6.3.0 gmp
mv -v mpc-1.3.1 mpc

# Set the build options
export  CARGS="--with-sysroot=/cross-tools "
export CARGS+="--prefix= " 
export CARGS+="--target=${LFS_TGT} "
export CARGS+="--enable-languages=c,c++ "
export CARGS+="--enable-default-hash-style=gnu "
export CARGS+="--enable-default-pie "
export CARGS+="--enable-static-pie  "
export CARGS+="--enable-relro "
export CARGS+="--enable-initfini-array "
export CARGS+="--disable-bootstrap "
export CARGS+="--disable-multilib "
export CARGS+="--disable-libsanitize "
export CARGS+="--disable-linker-build-id "
export CARGS+="--disable-rpath "
export CARGS+="--disable-werror "
export CARGS+="--disable-lto "

# The GCC documentation recommends building GCC in a dedicated build directory
mkdir -v build
cd       build

# Configure source:
../configure $CARGS

# Create a link for build to find kernel headers
mkdir -pv /cross-tools/usr 
ln -sv ../include /cross-tools/usr/include 

# Build GCC
make all-gcc

# Install without debugging symbols
make install-strip-gcc DESTDIR=/cross-tools

# Build static libgcc
CFLAGS='-pipe -g0 -O0' CXXFLAGS='-pipe -g0 -O0' make enable_shared=no all-target-libgcc

# Install static libgcc without debugging symbols
make install-strip-target-libgcc DESTDIR=/cross-tools

# Clean build target
make -C ${LFS_TGT}/libgcc distclean

# Rebuild libgcc as shared
make enable_shared=yes all-target-libgcc 

# Installed shared libgcc without debugging symbols
make install-strip-target-libgcc DESTDIR=/cross-tools

# Build libstdc++
make all-target-libstdc++-v3

# Install libstdc++ without debugging symbols
make install-strip-target-libstdc++-v3 DESTDIR=/cross-tools

# OPTIONAL: Build & install libgomp 
make all-target-libgomp
make install-strip-target-libgomp DESTDIR=/cross-tools

# OPTIONAL: Build & install libquadmath
make all-target-libquadmath
make install-strip-target-libquadmath DESTDIR=/cross-tools

# Dump the GCC spec file
export SPECFILE=`dirname $(${LFS_TGT}-gcc -print-libgcc-file-name)`/specs
${LFS_TGT}-gcc -dumpspecs > specs

# Adjust the specs file to set the correct dynamic loader by replacing all
# instances of /lib64/ld-linux-x86-64.so.2 to /cross-tools/lib/ld-linux-x86-64.so.2

# Then install it 
mv -v specs $SPECFILE
unset SPECFILE
