# Cross-Tools: Glibc 
# Build and install as lfs

# NOTE: Glibc headers required to build static GCC

# Some of the Glibc programs use the non-FHS-compliant 
# /var/db directory to store their runtime data. Apply the 
# following patch to make such programs store their runtime 
# data in the FHS-compliant locations: 
patch -Np1 -i ../patches/glibc-2.42-fhs-1.patch 

# The Glibc documentation recommends building Glibc in a 
# dedicated build directory:
mkdir -v build
cd       build

# Set the build options
export  CARGS="--prefix=/  "
export CARGS+="--host=$LFS_TGT "
export CARGS+="--build=$(../scripts/config.guess) "
export CARGS+="--enable-kernel=5.4 "
export CARGS+="--with-headers=/cross-tools/include "
export CARGS+="--disable-nscd "
export CARGS+="--disable-werror "
export CARGS+="--without-selinux "
export CARGS+="libc_cv_slibdir=/lib "

# Ensure that the ldconfig and sln utilities are installed into /cross-tools/bin:
echo "rootsbindir=/cross-tools/bin" > configparms 

# Configure the source
../configure $CARGS

# Compile
make

# Install to cross-tools
make install DESTDIR=/cross-tools

# Move misplaced binaries
mv /cross-tools/cross-tools/bin/* /cross-tools/bin/
rm -r /cross-tools/cross-tools

# Fix a hard coded path to the executable loader in the 
# ldd script (/cross-tools/bin/ldd)
sed -i 's/lib64/cross-tools\/lib64/g' /cross-tools/bin/ldd
sed -i 's/lib\/ld-linux.so.2/cross-tools\/lib\/ld-linux.so.2/g' /cross-tools/bin/ldd
sed -i 's/libx32/cross-tools\/libx32/g' /cross-tools/bin/ldd
