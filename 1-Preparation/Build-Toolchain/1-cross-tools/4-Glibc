# Cross-Tools: Glibc 
# Build and install as lfs

# NOTE: Glibc headers required to build static GCC

# Some of the Glibc programs use the non-FHS-compliant 
# /var/db directory to store their runtime data. Apply the 
# following patch to make such programs store their runtime 
# data in the FHS-compliant locations: 
patch -Np1 -i ../patches/glibc-2.42-fhs-1.patch 

# The Glibc documentation recommends building Glibc in a 
# dedicated build directory:
mkdir -v build
cd       build

# Set the build options
export  CARGS="--prefix=/  "
export CARGS+="--host=$LFS_TGT "
export CARGS+="--build=$(../scripts/config.guess) "
export CARGS+="--enable-kernel=5.4 "
export CARGS+="--with-headers=/cross-tools/include "
export CARGS+="--disable-nscd "
export CARGS+="--disable-werror "
export CARGS+="--without-selinux "
export CARGS+="libc_cv_slibdir=/lib "

# Ensure that the ldconfig and sln utilities are installed into /cross-tools/bin:
echo "rootsbindir=/cross-tools/bin" > configparms 

# Configure the source
../configure $CARGS

# Compile
make

# Install to cross-tools
make install DESTDIR=/cross-tools

# Move misplaced binaries
mv /cross-tools/cross-tools/bin/* /cross-tools/bin/
rm -r /cross-tools/cross-tools

# Fix a hard coded path to the executable loader in the 
# ldd script (/cross-tools/bin/ldd)
sed -i 's/lib64/cross-tools\/lib/g' /cross-tools/bin/ldd
sed -i 's/lib\/ld-linux.so.2/cross-tools\/lib32\/ld-linux.so.2/g' /cross-tools/bin/ldd
sed -i 's/libx32/cross-tools\/libx32/g' /cross-tools/bin/ldd

## Fix up the cross-tools

# Create a link so GCC can find the runtime objects
mv /cross-tools/x86_64-lfs-linux-gnu/lib/* /cross-tools/lib/
rm -rv /cross-tools/x86_64-lfs-linux-gnu/lib
ln -sv /cross-tools/lib /cross-tools/x86_64-lfs-linux-gnu/lib

# Create a GCC specs file to add correct search path for headers
export SPECFILE=`dirname $(${LFS_TGT}-gcc -print-libgcc-file-name)`/specs
${LFS_TGT}-gcc -dumpspecs > specs

# Modify specs to add /cross-tools/include path
sed -i 's/D_REENTRANT}/D_REENTRANT} -I\/cross-tools\/include /g' specs

# Install modified specs to the cross toolchain
mv -v specs $SPECFILE
unset SPECFILE

# Create missing link for lib64
ln -sv lib /cross-tools/lib64

## Build the 32-bit version of glibc

# clean the build directory:
rm -rf ./*

# Set the build options
export  CARGS="--prefix=/ "
export CARGS+="--host=$LFS_TGT32 "
export CARGS+="--build=$(../scripts/config.guess) "
export CARGS+="--enable-kernel=5.4 "
export CARGS+="--with-headers=/cross-tools/include "
export CARGS+="--disable-nscd "
export CARGS+="--libdir=/lib32 "
export CARGS+="--libexecdir=/lib32 "
export CARGS+="libc_cv_slibdir=/lib32 "

# Configure the 32-bit build
CC="$LFS_TGT-gcc -m32"  \
CXX="$LFS_TGT-g++ -m32" \
../configure $CARGS

# Compile
make

# Install to a temporary directory and install
# only what we need:
make DESTDIR=$PWD/DESTDIR install
cp -a DESTDIR/lib32  /cross-tools/
install -vm644 DESTDIR/include/gnu/{lib-names,stubs}-32.h \
               /cross-tools/include/gnu/
ln -svf ../lib32/ld-linux.so.2 /cross-tools/lib/ld-linux.so.2

