# Cross-Tools: libstdc++
# Build and install as lfs

# NOTE: Libstdc++ is part of the GCC sources. You should 
# first unpack the GCC tarball and change to the gcc-15.2.0 
# directory.

# Change the default directory name for libraries:
sed -e '/m64=/s/lib64/lib/' \
    -e '/m32=/s/m32=.*/m32=..\/lib32$(call if_multiarch,:i386-linux-gnu)/' \
    -i.orig gcc/config/i386/t-linux64

# Make -mstackrealign a default for 32bit objects: 
sed '/STACK_REALIGN_DEFAULT/s/0/(!TARGET_64BIT \&\& TARGET_SSE)/' \
      -i gcc/config/i386/i386.h

# Change the location of GCC's default dynamic linker to use the 
# one installed in /cross-tools. It also removes /usr/include from 
# GCC's include search path. Issue:
for file in gcc/config/{linux,i386/linux{,64}}.h
do
  cp -uv $file{,.orig}
  sed -e 's@/lib\(64\)\?\(32\)\?/ld@/cross-tools&@g' \
      -e 's@/usr@/cross-tools@g' $file.orig > $file
  echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/cross-tools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' >> $file
  touch $file.orig
done

# Set the build options
export  CARGS="--host=$LFS_TGT "
export CARGS+="--build=$(../config.guess) "
export CARGS+="--prefix=  "
export CARGS+="--enable-multilib "
export CARGS+="--disable-nls "
export CARGS+="--disable-libstdcxx-pch "
export CARGS+="--with-gxx-include-dir=/cross-tools/include/c++/15.2.0 "

# The GCC documentation recommends building libstdc++
# in a dedicated build directory
mkdir -v build
cd       build

# Configure source 
../libstdc++-v3/configure $CARGS

# Compile
make

# Install to cross-tools
make install-strip DESTDIR=/cross-tools

# Move misplaced headers
mv /cross-tools/cross-tools/include/c++ /cross-tools/include/

