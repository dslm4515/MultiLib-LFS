# Cross-Tools: static GCC 
# Build and install as lfs

# GCC now requires the GMP, MPFR and MPC packages to build.
# Unpack them in-tree.
xz -cd ../pkgs/mpfr-4.2.2.tar.xz | tar -xf -
xz -cd ../pkgs/gmp-6.3.0.tar.xz | tar -xf -
gzip -cd ../pkgs/mpc-1.3.1.tar.gz | tar -xf -
mv -v mpfr-4.2.2 mpfr
mv -v gmp-6.3.0 gmp
mv -v mpc-1.3.1 mpc

# Change the default directory name for libraries:
sed -e '/m64=/s/lib64/lib/' \
    -e '/m32=/s/m32=.*/m32=..\/lib32$(call if_multiarch,:i386-linux-gnu)/' \
    -i.orig gcc/config/i386/t-linux64

# Make -mstackrealign a default for 32bit objects: 
sed '/STACK_REALIGN_DEFAULT/s/0/(!TARGET_64BIT \&\& TARGET_SSE)/' \
      -i gcc/config/i386/i386.h

# The following command will change the location of GCC's default dynamic 
# linker to use the one installed in /tools. It also removes /usr/include 
# from GCC's include search path. Issue: 
for file in \
 $(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
do
  cp -uv $file{,.orig}
  sed -e 's@/lib\(64\)\?\(32\)\?/ld@/cross-tools&@g' \
      -e 's@/usr@/tools@g' $file.orig > $file
  echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/cross-tools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' >> $file
  touch $file.orig
done

# Set the build options
#export  CARGS="--with-sysroot=/cross-tools/${LFS_TGT} "
#export CARGS+="--with-build-sysroot=/cross-tools/${LFS_TGT} "
export  CARGS="--with-sysroot=/cross-tools "
export CARGS+="--with-build-sysroot=/cross-tools "
export CARGS+="--prefix=/cross-tools " 
export CARGS+="--target=${LFS_TGT} "
export CARGS+="--enable-languages=c,c++ "
export CARGS+="--enable-default-hash-style=gnu "
export CARGS+="--enable-default-pie "
export CARGS+="--enable-static-pie  "
export CARGS+="--enable-relro "
export CARGS+="--enable-initfini-array "
export CARGS+="--disable-bootstrap "
#export CARGS+="--with-multilib-list=m64,m32 "
export CARGS+="--disable-multilib "
export CARGS+="--disable-libsanitize "
export CARGS+="--disable-linker-build-id "
export CARGS+="--disable-rpath "
export CARGS+="--disable-werror "

# The GCC documentation recommends building GCC in a dedicated build directory
mkdir -v build
cd       build

# Configure source:
../configure $CARGS

# Create a link for build to find kernel headers
#mkdir -pv /cross-tools/${LFS_TGT}/usr 
#ln -sv ../include /cross-tools/${LFS_TGT}/usr/include 
mkdir -pv /cross-tools/usr 
ln -sv ../include /cross-tools/usr/include 

# Build GCC
make all-gcc

# Install without debugging symbols
make install-strip-gcc

# Build static libgcc
CFLAGS='-pipe -g0 -O0' CXXFLAGS='-pipe -g0 -O0' make enable_shared=no all-target-libgcc

# Install static libgcc without debugging symbols
make install-strip-target-libgcc

# Clean build target
make -C ${LFS_TGT}/libgcc distclean

# Make sure runtime objects [and libraries] can be found
# * Binutils was not built correctly as this directory 
# should not be required: /cross-tools/cross-tools/lib
mv /cross-tools/${LFS_TGT}/lib/* /cross-tools/lib/
rm -rf /cross-tools/${LFS_TGT}/lib
ln -sv ../lib /cross-tools/${LFS_TGT}/lib
mkdir /cross-tools/cross-tools
ln -sv ../lib /cross-tools/cross-tools/lib

# Rebuild libgcc as shared
make enable_shared=yes all-target-libgcc

# Installed shared libgcc without debugging symbols
make install-strip-target-libgcc

# Build libstdc++
make all-target-libstdc++-v3

# Install libstdc++ without debugging symbols
make install-strip-target-libstdc++-v3

# OPTIONAL: Build & install libgomp 
make all-target-libgomp
make install-strip-target-libgomp

# OPTIONAL: Build & install libquadmath
make all-target-libquadmath
make install-strip-target-libquadmath
