# Tools: Adjusting cross-tools 
# Build and install as lfs

## Adjust cross-tools so that binaries build
## with dynamic loader path at /tools/lib

# Dump current cross-gcc specs 
export SPECFILE=`dirname $(${LFS_TGT}-gcc -print-libgcc-file-name)`/specs
${LFS_TGT}-gcc -dumpspecs > specs

# Modify specs from cross-tools to tools
sed -i 's/cross-tools/tools/g' specs

# Install new specs to the cross toolchain 
mv -v $SPECFILE ${SPECFILE}.old
mv -v specs  $SPECFILE
unset SPECFILE

# Adjust binutils scripts ... doesnt matter. Looks like scripts
# are baked into gcc in cross-tools
#sed -i 's/cross-tools/tools/g'    /cross-tools/lib/ldscripts/* 

##  Test cross-tools for 64-bit & 32-bit  builds
export SFP="--spec ${LFS}/sources/files/specs-tools "
echo 'int main(){}' | $LFS_TGT-gcc $SFP -x c - -v -Wl,--verbose &> dummy.log
readelf -l a.out | grep ': /tools'
echo 'int main(){}' | $LFS_TGT-gcc $SFP -m32 -x c - -v -Wl,--verbose &> dummy32.log
readelf -l a.out | grep ': /tools'

# If everything is working correctly, there should be no errors, and
# the output of the readelf commands will be of the form:
# [Requesting program interpreter: /tools/lib/ld-linux-x86-64.so.2]
# [Requesting program interpreter: /tools/lib32/ld-linux.so.2]

# Make sure that we're set up to use the correct start files: 
grep -E -o "/tools/lib.*/S?crt[1in].*succeeded" dummy.log

# The output of the above command should be:
# /tools/lib/Scrt1.o succeeded
# /tools/lib/crti.o succeeded
# /tools/lib/crtn.o succeeded

grep -E -o "/tools/lib.*/S?crt[1in].*succeeded" dummy32.log

# The output of the above command should be:
# /tools/lib32/Scrt1.o succeeded
# /tools/lib32/crti.o succeeded
# /tools/lib32/crtn.o succeeded

# Verify that the compiler is searching for the correct header files:
grep -A3 "search starts here"  dummy.log

# The output of the above command should be:
# #include "..." search starts here:
# #include <...> search starts here:
#  /tools/include
#  /mnt/glfs/cross-tools/bin/../lib/gcc/x86_64-lfs-linux-gnu/15.2.0/include
# End of search list.

grep -A3 "search starts here"  dummy.log
# The output of the above command should be:
# #include "..." search starts here:
# #include <...> search starts here:
#  /tools/include
#  /mnt/glfs/cross-tools/bin/../lib/gcc/x86_64-lfs-linux-gnu/15.2.0/include
# End of search list.

# Make sure that we're using the correct libc:
grep "/lib.*/libc.so.6 " dummy.log

# The output of the above command should be:
# attempt to open /tools/lib/libc.so.6 succeeded

grep "/lib.*/libc.so.6 " dummy32.log
# The output of the above command should be:
# attempt to open /tools/lib32/libc.so.6 succeeded

#  Make sure GCC is using the correct dynamic linker: 
grep "/lib.*/libc.so.6 " dummy.log

# The output of the above command should be:
# attempt to open /tools/lib/libc.so.6 succeeded

grep "/lib.*/libc.so.6 " dummy32.log
# The output of the above command should be:
# found ld-linux.so.2 at /tools/lib32/ld-linux.so.2

# Once all is well, clean up the test files:
rm -v dummy.log dummy32.log a.out
